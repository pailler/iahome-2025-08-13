version: '3.8'

services:
  # Application Stable Diffusion avec Gradio
  stablediffusion:
    image: stability-ai/stable-diffusion:latest
    container_name: stablediffusion-app
    restart: unless-stopped
    environment:
      - GRADIO_SERVER_NAME=0.0.0.0
      - GRADIO_SERVER_PORT=7860
      - GRADIO_ALLOWED_PATHS=["/tmp"]
      - GRADIO_ROOT_PATH=""
    ports:
      - "7860:7860"
    volumes:
      - ./models:/app/models
      - ./outputs:/app/outputs
      - ./inputs:/app/inputs
    networks:
      - stablediffusion-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7860"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Proxy Nginx avec authentification JWT
  stablediffusion-proxy:
    image: nginx:alpine
    container_name: stablediffusion-proxy
    restart: unless-stopped
    ports:
      - "8080:80"
    volumes:
      - ./nginx-stablediffusion.conf:/etc/nginx/nginx.conf:ro
      - ./stablediffusion-jwt-auth.py:/app/stablediffusion-jwt-auth.py:ro
      - ./logs:/var/log
    environment:
      - JWT_SECRET=iahome-super-secret-jwt-key-2025-change-this-in-production
      - STABLEDIFFUSION_PORT=7860
      - AUTH_REQUIRED=true
      - LOG_LEVEL=INFO
    depends_on:
      - stablediffusion
    networks:
      - stablediffusion-network
    command: >
      sh -c "
        apk add --no-cache python3 py3-pip curl &&
        pip3 install pyjwt requests &&
        python3 /app/stablediffusion-jwt-auth.py
      "

networks:
  stablediffusion-network:
    driver: bridge

volumes:
  models:
  outputs:
  inputs: 